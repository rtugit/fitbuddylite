<div class="workout-layout">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="fb-card chat-card">
          <!-- Header -->
          <div class="chat-header d-flex align-items-center mb-3">
            <div class="chat-avatar me-3">
              <span>AI</span>
            </div>
            <div>
              <h5 class="mb-0"><%= @workout_plan.goal %></h5>
              <small class="text-muted">
                Level: <%= @workout_plan.level %> Â· <%= @workout_plan.duration_minutes %> min
              </small>
            </div>
          </div>

          <!-- Chat Box -->
          <div class="chat-box">
            <div class="chat-body" id="chatBody">
              <% if @ai_messages.any? %>
                <% @ai_messages.order(:created_at).each do |message| %>
                  <% is_user = (message.role == "user") %>
                  <div class="chat-row <%= is_user ? 'justify-content-end' : 'justify-content-start' %>">
                    <div class="chat-bubble <%= is_user ? 'bubble-user' : 'bubble-ai' %>">
                      <p class="mb-1"><%= simple_format(message.content) %></p>
                      <small class="chat-meta">
                        <%= is_user ? "You" : "AI" %> Â·
                        <%= l(message.created_at, format: :short) %>
                      </small>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <p class="text-muted text-center mb-0">
                  No messages yet â€“ say hi to your AI coach ðŸ‘‹
                </p>
              <% end %>
            </div>

            <!-- Input -->
            <div class="chat-input-area">
              <%= form_with model: [@workout_plan, @chat, @ai_message], local: true do |f| %>
                <div class="input-group mb-2">
                  <%= f.text_area :content,
                                  rows: 2,
                                  class: "form-control chat-input",
                                  placeholder: "Ask your AI coach something about this workout...",
                                  required: true %>
                  <button class="btn btn-primary" type="submit">
                    Send
                  </button>
                </div>
              <% end %>

              <% if @workout_plan.ai_plan.present? %>
                <%= button_to "ðŸ¤– Revise My Plan",
                    revise_plan_workout_plan_chat_path(@workout_plan, @chat),
                    method: :post,
                    class: "btn btn-outline-primary btn-sm w-100" %>
              <% end %>
            </div>
          </div>

          <div class="mt-3">
            <%= link_to "â† Back to workout plan", workout_plan_path(@workout_plan), class: "text-muted small" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var chatBody = document.getElementById("chatBody");
    if (chatBody) {
      chatBody.scrollTop = chatBody.scrollHeight;
    }
  });
</script>
